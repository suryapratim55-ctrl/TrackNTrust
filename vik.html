<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VIKSHIT - Real-Time Public Transport</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { font-family:"Inter", sans-serif; }

/* Hero section background with overlay */
.hero-bg {
  background: url("cartoon-mobile-phone-autobus-illustration-public-transportation-gps-navigation_126283-2830.jpg")
              no-repeat center center;
  background-size: cover;
  position: relative;
}
.hero-bg::before {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6); /* overlay for text readability */
}
.hero-content {
  position: relative;
  z-index: 1;
  animation: fadeIn 1.5s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(0);}
  to { opacity: 1; transform: translateY(0);}
}

.btn-primary {
  background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow:0 10px 20px rgba(0,0,0,0.2);
}
.card-hover { transition: all 0.3s ease; }
.card-hover:hover { transform:translateY(-10px); box-shadow:0 20px 40px rgba(0,0,0,0.1); }
.map-container { height:400px; width:100%; }

/* Occupancy colors */
.occupancy-low { color: #22c55e; } /* Green */
.occupancy-medium { color: #eab308; } /* Yellow */
.occupancy-full { color: #ef4444; } /* Red */

/* Seat Matrix Styles */
.seat-matrix {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* Example: 4 seats per row */
  gap: 10px;
  max-width: 300px;
  margin: 20px auto;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
  background-color: #f9f9f9;
}
.seat {
  width: 50px;
  height: 50px;
  display: flex;
  flex-direction: column; /* Allow content to stack */
  align-items: center;
  justify-content: center;
  border: 1px solid #aaa;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.8em;
  font-weight: bold;
  position: relative;
  padding: 2px; /* Add some padding */
}
.seat.vacant { background-color: #d4edda; border-color: #28a745; } /* Greenish */
.seat.occupied { background-color: #f8d7da; border-color: #dc3545; cursor: not-allowed; } /* Reddish */
.seat.selected { background-color: #cce5ff; border-color: #007bff; } /* Bluish */
.seat-type {
  position: absolute;
  top: 2px; /* Changed from bottom to top */
  right: 2px;
  font-size: 0.6em;
  color: #666;
}
.seat.occupied .seat-type { color: #a00; }
.seat.vacant .seat-type { color: #0a0; }
.seat-booked-by {
  font-size: 0.6em;
  color: #555;
  margin-top: 2px;
  text-align: center;
  word-break: break-all; /* Break long names */
}

/* Dark Mode Styles */
body.dark-mode {
  background-color: #1a202c; /* Dark background */
  color: #e2e8f0; /* Light text */
}
body.dark-mode .bg-gray-50 { background-color: #2d3748; }
body.dark-mode .bg-white { background-color: #4a5568; }
body.dark-mode .text-gray-800 { color: #e2e8f0; }
body.dark-mode .border { border-color: #718096; }
body.dark-mode input, body.dark-mode textarea, body.dark-mode select {
  background-color: #2d3748;
  color: #e2e8f0;
  border-color: #718096;
}
body.dark-mode input::placeholder, body.dark-mode textarea::placeholder {
  color: #a0aec0; /* Dark mode placeholder color */
}
body.dark-mode .bg-white\/10 { background-color: rgba(74, 85, 104, 0.5); }
body.dark-mode .bg-blue-50 { background-color: #2a4365; }
body.dark-mode .bg-yellow-50 { background-color: #4a320a; }
body.dark-mode .bg-purple-50 { background-color: #322659; }
body.dark-mode .bg-green-50 { background-color: #2f855a; } /* Darker green for seat section */
body.dark-mode .text-gray-500 { color: #a0aec0; }
body.dark-mode .text-gray-600 { color: #cbd5e0; }
body.dark-mode .text-gray-700 { color: #a0aec0; }
body.dark-mode .bg-gray-100 { background-color: #2d3748; }
body.dark-mode .hover\:bg-gray-200:hover { background-color: #4a5568; }
body.dark-mode .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3); }
body.dark-mode .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3); }
body.dark-mode .hero-bg::before { background: rgba(0,0,0,0.8); } /* Darker overlay */

/* Seat matrix dark mode */
body.dark-mode .seat-matrix {
  background-color: #2d3748;
  border-color: #718096;
}
body.dark-mode .seat {
  border-color: #718096;
}
body.dark-mode .seat.vacant { background-color: #38a169; border-color: #2f855a; }
body.dark-mode .seat.occupied { background-color: #c53030; border-color: #9b2c2c; }
body.dark-mode .seat.selected { background-color: #4299e1; border-color: #3182ce; }
body.dark-mode .seat-type { color: #cbd5e0; }
body.dark-mode .seat.occupied .seat-type { color: #fbd38d; }
body.dark-mode .seat.vacant .seat-type { color: #9ae6b4; }
body.dark-mode .seat-booked-by { color: #cbd5e0; }

/* Custom Leaflet Div Icons */
.custom-div-icon {
  background: none;
  border: none;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 20px;
  border: 1px solid #888;
  width: 90%;
  max-width: 500px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  animation: slide-in 0.3s forwards;
}

@keyframes slide-in {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.close-btn {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}
.close-btn:hover,
.close-btn:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}
</style>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="mainApp" class="min-h-screen">

<section id="homePage" class="min-h-screen hero-bg text-white flex items-center justify-center">
  <div class="max-w-4xl mx-auto px-4 text-center hero-content">
    <h1 class="text-5xl md:text-7xl font-bold mb-6 leading-tight">VIKSHIT TRANSPORT</h1>
    <p class="text-xl md:text-3xl mb-12 opacity-90">Real-Time Public Transport Tracking for Small Cities</p>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
      <div class="card-hover bg-white/10 backdrop-blur-sm p-8 rounded-xl border border-white/20">
        <i class="fas fa-id-card text-6xl mb-6"></i>
        <h2 class="text-3xl font-semibold mb-4">Driver Mode</h2>
        <p class="mb-6">Share your live location to help commuters track your bus</p>
        <button onclick="selectMode('driver')" class="btn-primary text-white px-8 py-4 rounded-lg font-semibold text-lg hover:scale-105 transition">Enter Driver Mode</button>
      </div>
      <div class="card-hover bg-white/10 backdrop-blur-sm p-8 rounded-xl border border-white/20">
        <i class="fas fa-user text-6xl mb-6"></i>
        <h2 class="text-3xl font-semibold mb-4">User Mode</h2>
        <p class="mb-6">Find buses, track live locations, and get accurate ETAs</p>
        <button onclick="selectMode('user')" class="btn-primary text-white px-8 py-4 rounded-lg font-semibold text-lg hover:scale-105 transition">Enter User Mode</button>
      </div>
    </div>
    <div class="mt-8">
      <button onclick="showAdminLogin()" class="text-white text-lg hover:underline">Admin / Authority Login</button>
    </div>
    <div class="mt-4">
      <select id="languageSelector" onchange="changeLanguage(this.value)" class="bg-white/20 text-white p-2 rounded-lg">
        <option value="en">English</option>
        <option value="hi">हिंदी</option>
        </select>
    </div>
    <div class="mt-4">
      <button id="themeToggle" onclick="toggleTheme()" class="text-white text-2xl p-2 rounded-full bg-white/20 hover:bg-white/30 transition">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </div>
</section>

<section id="driverPage" class="min-h-screen py-20 bg-gray-100 hidden">
<div class="max-w-4xl mx-auto px-4">
<div class="bg-white rounded-xl shadow-xl p-8">
<div class="flex justify-between items-center mb-6">
  <button onclick="backToHome()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">← Back to Home</button>
  <div class="flex items-center space-x-2">
    <select onchange="changeLanguage(this.value)" class="bg-gray-200 text-gray-800 p-2 rounded-lg">
      <option value="en">English</option>
      <option value="hi">हिंदी</option>
    </select>
    <button onclick="toggleTheme()" class="text-gray-600 text-2xl p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition">
      <i class="fas fa-moon"></i>
    </button>
  </div>
</div>
<div id="driverAuthentication">
<h2 class="text-4xl font-bold mb-8 text-center">Driver Portal</h2>

<div id="driverLogin" class="mb-8">
<h3 class="text-2xl font-semibold mb-4">Log In as Existing Driver</h3>
<div class="space-y-4 max-w-md mx-auto">
<input type="text" placeholder="Driver ID" id="driverId" class="w-full p-3 border rounded-lg"/>
<input type="password" placeholder="Password" id="driverPassword" class="w-full p-3 border rounded-lg"/>
<button onclick="driverLogin()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">Login</button>
</div>
<p class="text-center mt-4">New driver? <button onclick="showDriverRegistration()" class="text-indigo-600 hover:text-indigo-800 underline">Register here</button></p>
<p class="text-center mt-2"><button onclick="forgotPassword()" class="text-indigo-600 hover:text-indigo-800 underline">Forgot Password?</button></p>
</div>

<div id="driverRegistration" class="hidden">
<h3 class="text-2xl font-semibold mb-4">Register as New Driver</h3>
<div class="space-y-4 max-w-md mx-auto">
<input type="text" placeholder="Full Name" id="regDriverName" class="w-full p-3 border rounded-lg"/>
<input type="text" placeholder="Driver ID" id="regDriverId" class="w-full p-3 border rounded-lg"/>
<input type="password" placeholder="Password" id="regDriverPassword" class="w-full p-3 border rounded-lg"/>
<input type="text" placeholder="Bus Route Name" id="regRouteName" class="w-full p-3 border rounded-lg"/>
<input type="text" placeholder="Bus Route Number" id="regRouteNumber" class="w-full p-3 border rounded-lg"/>
<input type="email" placeholder="Email ID" id="regEmail" class="w-full p-3 border rounded-lg"/>
<input type="tel" placeholder="Mobile Number" id="regMobile" class="w-full p-3 border rounded-lg"/>

<h4 class="text-xl font-semibold mt-6 mb-2">Define Bus Route Stops & Schedule</h4>
<div id="routeStopsContainer" class="space-y-2 border p-3 rounded-lg">
  <div class="flex space-x-2 mb-2">
    <input type="text" placeholder="Stop Name (e.g., 'Main Station')" class="w-2/3 p-2 border rounded-lg stop-name-input"/>
    <input type="time" value="09:00" class="w-1/3 p-2 border rounded-lg stop-time-input"/>
  </div>
</div>
<button onclick="addRouteStopField()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold mt-2">Add Stop</button>

<button onclick="driverRegister()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold mt-6">Register</button>
</div>
<p class="text-center mt-4">Already registered? <button onclick="showDriverLogin()" class="text-indigo-600 hover:text-indigo-800 underline">Login here</button></p>
</div>
</div>

<div id="driverPanel" class="hidden">
<h2 class="text-4xl font-bold mb-8 text-center">Driver Dashboard</h2>
<div class="mb-4 p-4 bg-blue-50 rounded-lg">
<p><strong>Name:</strong> <span id="driverNameDisplay"></span></p>
<p><strong>Route:</strong> <span id="driverRouteDisplay"></span></p>
</div>
<h3 class="text-2xl font-semibold mb-4">Share Your Live Location</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div>
<div class="bg-gray-50 p-6 rounded-lg">
<h4 class="font-semibold mb-2">Location Status</h4>
<div class="space-y-2">
<p id="locationStatus">Initializing...</p>
<p id="currentLocation">Position: --</p>
<p id="locationTimestamp">Last Update: --</p>
</div>
</div>
<div class="mt-4">
<button onclick="startLocationSharing()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold mr-4">Start Sharing</button>
<button onclick="stopLocationSharing()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold">Stop Sharing</button>
</div>

<div class="mt-6 bg-gray-50 p-6 rounded-lg">
  <h4 class="font-semibold mb-2">Update Occupancy Level</h4>
  <select id="occupancyLevel" class="w-full p-3 border rounded-lg mb-4">
    <option value="Low">Low</option>
    <option value="Medium">Medium</option>
    <option value="Full">Full</option>
  </select>
  <button onclick="updateOccupancy()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">Update Occupancy</button>
</div>

<div class="mt-6 bg-gray-50 p-6 rounded-lg">
  <h4 class="font-semibold mb-2">Set Route Fare</h4>
  <input type="number" placeholder="Enter Fare (e.g., 50)" id="routeFare" class="w-full p-3 border rounded-lg mb-4"/>
  <button onclick="updateRouteFare()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">Update Fare</button>
</div>

<div class="mt-6">
  <button onclick="showBookedSeats()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold">
    <i class="fas fa-ticket-alt mr-2"></i> View Booked Seats
  </button>
</div>

<div class="mt-6">
  <button onclick="triggerEmergency('driver')" class="w-full bg-red-700 hover:bg-red-800 text-white py-3 rounded-lg font-semibold">
    <i class="fas fa-exclamation-triangle mr-2"></i> Emergency Alert
  </button>
</div>

</div>
<div class="map-container rounded-lg" id="driverMap"></div>
</div>
</div>
</div>
</div>
</section>

<section id="userPage" class="min-h-screen py-20 bg-white hidden">
<div class="max-w-6xl mx-auto px-4">
<div class="bg-gray-50 rounded-xl shadow-xl p-8">
<div class="flex justify-between items-center mb-6">
  <button onclick="backToHome()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">← Back to Home</button>
  <div class="flex items-center space-x-2">
    <select onchange="changeLanguage(this.value)" class="bg-gray-200 text-gray-800 p-2 rounded-lg">
      <option value="en">English</option>
      <option value="hi">हिंदी</option>
    </select>
    <button onclick="toggleTheme()" class="text-gray-600 text-2xl p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition">
      <i class="fas fa-moon"></i>
    </button>
  </div>
</div>
<h2 class="text-4xl font-bold mb-8 text-center">Find Your Bus</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto mb-6">
<div class="relative">
  <input type="text" placeholder="Start Location" id="startLocation" class="w-full p-3 border rounded-lg" oninput="showSuggestions('startLocation', 'startSuggestions')"/>
  <ul id="startSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden"></ul>
</div>
<div class="relative">
  <input type="text" placeholder="End Location" id="endLocation" class="w-full p-3 border rounded-lg" oninput="showSuggestions('endLocation', 'endSuggestions')"/>
  <ul id="endSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden"></ul>
</div>
</div>
<button onclick="searchRoutes()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold block mx-auto mb-6">Search Routes</button>
<div class="max-w-2xl mx-auto mb-6">
<input type="text" placeholder="Search Bus by Name/Number" id="busSearch" class="w-full p-3 border rounded-lg" oninput="filterBuses()"/>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div id="busList" class="bg-white p-6 rounded-lg shadow-md">
<h3 class="text-xl font-semibold mb-4">Available Buses</h3>
<div id="busItems" class="space-y-4"><p class="text-gray-500">Select a route to see buses</p></div>
</div>
<div class="lg:col-span-2">
<div class="map-container rounded-lg" id="userMap"></div>
</div>
</div>

<div id="seatBookingSection" class="mt-8 p-6 bg-green-50 rounded-lg hidden">
  <h3 class="text-2xl font-semibold mb-4">Seat Selection for <span id="selectedBusName"></span> <span id="routeFareDisplay" class="text-base font-normal"></span></h3>
  <div id="seatMatrix" class="seat-matrix">
    </div>
  <div id="bookingForm" class="mt-6 p-4 bg-white rounded-lg shadow-md hidden">
    <h4 class="text-xl font-semibold mb-4">Book Seat <span id="selectedSeatNumber"></span></h4>
    <div class="space-y-3">
      <input type="text" placeholder="Your Name" id="bookingName" class="w-full p-3 border rounded-lg"/>
      <input type="text" placeholder="Aadhar Number" id="bookingAadhar" class="w-full p-3 border rounded-lg"/>
      <p class="text-sm text-gray-600">Payment Method: Cash Payment</p>
      <button onclick="confirmBooking()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">Book Now (Cash Payment)</button>
    </div>
  </div>
</div>


<div class="mt-8 p-6 bg-blue-50 rounded-lg text-center">
  <h3 class="text-2xl font-semibold mb-4">Digital Ticketing</h3>
  <p class="text-gray-700 mb-4">Scan QR or use UPI to purchase tickets.</p>
  <button onclick="openTicketing()" class="btn-primary text-white px-8 py-4 rounded-lg font-semibold text-lg">
    <i class="fas fa-ticket-alt mr-2"></i> Buy Ticket
  </button>
</div>

<div class="mt-8 p-6 bg-yellow-50 rounded-lg">
  <h3 class="text-2xl font-semibold mb-4">Provide Feedback</h3>
  <textarea id="feedbackText" class="w-full p-3 border rounded-lg mb-4" rows="4" placeholder="Report issues like delays, overcrowding, or driver behavior..."></textarea>
  <button onclick="submitFeedback()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">
    <i class="fas fa-paper-plane mr-2"></i> Submit Feedback
  </button>
</div>

<div class="mt-8 p-6 bg-purple-50 rounded-lg">
  <h3 class="text-2xl font-semibold mb-4">Set Bus Alerts</h3>
  <div class="space-y-4">
    <input type="text" placeholder="Bus Name/Number (e.g., 'Route 10')" id="alertBus" class="w-full p-3 border rounded-lg"/>
    <input type="text" placeholder="Stop Name (e.g., 'Market Square')" id="alertStop" class="w-full p-3 border rounded-lg"/>
    <input type="number" placeholder="Minutes away (e.g., 10)" id="alertMinutes" class="w-full p-3 border rounded-lg"/>
    <button onclick="setBusAlert()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">
      <i class="fas fa-bell mr-2"></i> Set Alert
    </button>
  </div>
  <p class="text-sm text-gray-600 mt-4">Note: Push notifications and SMS alerts require backend support.</p>
</div>

<div class="mt-8">
  <button onclick="triggerEmergency('user')" class="w-full bg-red-700 hover:bg-red-800 text-white py-3 rounded-lg font-semibold">
    <i class="fas fa-exclamation-triangle mr-2"></i> Emergency Alert
  </button>
</div>

</div>
</div>
</section>

<section id="adminLoginPage" class="min-h-screen py-20 bg-gray-100 hidden">
  <div class="max-w-md mx-auto px-4 bg-white rounded-xl shadow-xl p-8">
    <button onclick="backToHome()" class="mb-6 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">← Back to Home</button>
    <h2 class="text-4xl font-bold mb-8 text-center">Admin / Authority Login</h2>
    <div class="space-y-4">
      <input type="text" placeholder="Admin ID" id="adminId" class="w-full p-3 border rounded-lg"/>
      <input type="password" placeholder="Password" id="adminPassword" class="w-full p-3 border rounded-lg"/>
      <button onclick="adminLogin()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">Login</button>
    </div>
    <p class="text-center mt-4 text-gray-600">This dashboard requires a robust backend for full functionality.</p>
  </div>
</section>

<div id="bookedSeatsModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('bookedSeatsModal')">&times;</span>
    <h3 class="text-2xl font-bold mb-4">Booked Seats on Your Bus</h3>
    <p id="modalBusInfo" class="mb-4 text-gray-600"></p>
    <div id="bookedSeatsList" class="space-y-2">
      </div>
  </div>
</div>

<script>
let currentMode="home", driverInterval=null, driverMap, userMap, driverMarker, busMarkers={}, isSharing=false;
let registeredDrivers=JSON.parse(localStorage.getItem("drivers"))||[];
let allBuses=JSON.parse(localStorage.getItem("buses"))||[];
let userLocationMarker = null; // New: Marker for user's own location

// New: Default Seat Matrix Layout
const defaultSeatLayout = [
  { id: "A1", type: "window", status: "vacant", bookedBy: null, aadhar: null },
  { id: "A2", type: "aisle", status: "vacant", bookedBy: null, aadhar: null },
  { id: "A3", type: "aisle", status: "vacant", bookedBy: null, aadhar: null },
  { id: "A4", type: "window", status: "vacant", bookedBy: null, aadhar: null },
  { id: "B1", type: "window", status: "vacant", bookedBy: null, aadhar: null },
  { id: "B2", type: "aisle", status: "vacant", bookedBy: null, aadhar: null },
  { id: "B3", type: "aisle", status: "vacant", bookedBy: null, aadhar: null },
  { id: "B4", type: "window", status: "vacant", bookedBy: null, aadhar: null },
  { id: "C1", type: "window", status: "vacant", bookedBy: null, aadhar: null },
  { id: "C2", type: "aisle", status: "vacant", bookedBy: null, aadhar: null },
  { id: "C3", type: "aisle", status: "vacant", bookedBy: null, aadhar: null },
  { id: "C4", type: "window", status: "vacant", bookedBy: null, aadhar: null },
  { id: "D1", type: "window", status: "vacant", bookedBy: null, aadhar: null },
  { id: "D2", type: "aisle", status: "vacant", bookedBy: null, aadhar: null },
  { id: "D3", type: "aisle", status: "vacant", bookedBy: null, aadhar: null },
  { id: "D4", type: "window", status: "vacant", bookedBy: null, aadhar: null },
];

let selectedBusForBooking = null;
let selectedSeat = null;

// Save to localStorage
function saveData(){
  try {
    localStorage.setItem("drivers",JSON.stringify(registeredDrivers));
    localStorage.setItem("buses",JSON.stringify(allBuses));
    console.log("Data saved to localStorage.");
  } catch (e) {
    console.error("Error saving to localStorage:", e);
    alert("Could not save data. Local storage might be full or disabled.");
  }
}

// New: Load data with offline support consideration
function loadData() {
  try {
    registeredDrivers = JSON.parse(localStorage.getItem("drivers")) || [];
    allBuses = JSON.parse(localStorage.getItem("buses")) || [];
    console.log("Data loaded from localStorage.");
  } catch (e) {
    console.error("Error loading from localStorage:", e);
    alert("Could not load data from local storage. Data might be corrupted.");
    registeredDrivers = [];
    allBuses = [];
  }
}
loadData(); // Load data on script start

function selectMode(mode){
document.getElementById("homePage").classList.add("hidden");
if(mode==="driver"){document.getElementById("driverPage").classList.remove("hidden");currentMode="driver";initDriverMap();}
else if(mode==="user"){document.getElementById("userPage").classList.remove("hidden");currentMode="user";initUserMap();
  // New: Start watching user's location when entering user mode
  startUserLocationTracking();
}
}
function backToHome(){
document.getElementById("driverPage").classList.add("hidden");
document.getElementById("userPage").classList.add("hidden");
document.getElementById("adminLoginPage").classList.add("hidden"); // New: Hide admin page
document.getElementById("homePage").classList.remove("hidden");
currentMode="home";
if(driverInterval){navigator.geolocation.clearWatch(driverInterval);}
if(userLocationWatchId){navigator.geolocation.clearWatch(userLocationWatchId);} // New: Stop user location tracking
isSharing=false;
// New: Hide seat booking section when going back to home
document.getElementById("seatBookingSection").classList.add("hidden");
selectedBusForBooking = null;
selectedSeat = null;
}

// New: Add Route Stop Field
function addRouteStopField() {
  const container = document.getElementById("routeStopsContainer");
  const div = document.createElement("div");
  div.className = "flex space-x-2 mb-2";
  div.innerHTML = `
    <input type="text" placeholder="Stop Name (e.g., 'Market Square')" class="w-2/3 p-2 border rounded-lg stop-name-input"/>
    <input type="time" value="09:00" class="w-1/3 p-2 border rounded-lg stop-time-input"/>
    <button onclick="this.parentNode.remove()" class="bg-red-400 hover:bg-red-500 text-white px-2 py-1 rounded-lg">X</button>
  `;
  container.appendChild(div);
}


// Driver Register/Login
function showDriverRegistration(){
  document.getElementById("driverLogin").classList.add("hidden");
  document.getElementById("driverRegistration").classList.remove("hidden");
  // Ensure at least one stop field is present
  if (document.querySelectorAll('.stop-name-input').length === 0) {
    addRouteStopField();
  }
}
function showDriverLogin(){document.getElementById("driverRegistration").classList.add("hidden");document.getElementById("driverLogin").classList.remove("hidden");}
function driverRegister(){
const name=document.getElementById("regDriverName").value.trim();
const id=document.getElementById("regDriverId").value.trim();
const password=document.getElementById("regDriverPassword").value.trim();
const routeName=document.getElementById("regRouteName").value.trim();
const routeNumber=document.getElementById("regRouteNumber").value.trim();
const email=document.getElementById("regEmail").value.trim();
const mobile=document.getElementById("regMobile").value.trim();

// New: Get route stops and times
const stopNameInputs = document.querySelectorAll('.stop-name-input');
const stopTimeInputs = document.querySelectorAll('.stop-time-input');
const stops = [];
for (let i = 0; i < stopNameInputs.length; i++) {
  const stopName = stopNameInputs[i].value.trim();
  const scheduledTime = stopTimeInputs[i].value.trim();
  if (stopName && scheduledTime) {
    // For demo, using fixed coordinates for stops. In real app, these would be geo-coded.
    // Using a simple hash for demo coordinates based on stop name
    const lat = 22.5726 + (stopName.length * 0.001);
    const lng = 88.3639 + (stopName.charCodeAt(0) * 0.001);
    stops.push({ name: stopName, scheduledTime: scheduledTime, lat: lat, lng: lng });
  }
}

if(!name||!id||!password||!routeName||!routeNumber||!email||!mobile){alert("Fill all fields."); return;}
if(stops.length < 2){alert("Please define at least two stops (start and end) for the route."); return;} // New validation
if(registeredDrivers.some(d=>d.id===id)){alert("Driver ID exists!"); return;}

registeredDrivers.push({name,id,password,routeName,routeNumber,email,mobile});
// New: Add initial occupancy and stops to bus data, and assign a DEEP COPY of seat layout
allBuses.push({
  id:id,
  name:routeName,
  route:routeName, // This is the route name
  lat:22.5726, // Initial bus location
  lng:88.3639, // Initial bus location
  eta:"N/A",
  fare: 0, // New: Default fare
  occupancy: "Low",
  stops: stops, // Defined stops with scheduled times and coordinates
  seats: JSON.parse(JSON.stringify(defaultSeatLayout)) // Deep copy of default seat layout
});
saveData();alert("Registered! Login now."); showDriverLogin();
}
function driverLogin(){
const id=document.getElementById("driverId").value.trim();
const password=document.getElementById("driverPassword").value.trim();
const driver=registeredDrivers.find(d=>d.id===id&&d.password===password);
if(!driver){alert("Invalid ID or Password!"); return;}
document.getElementById("driverAuthentication").classList.add("hidden");
document.getElementById("driverPanel").classList.remove("hidden");
document.getElementById("driverNameDisplay").textContent=driver.name;
document.getElementById("driverRouteDisplay").textContent=`${driver.routeName} (${driver.routeNumber})`;
// New: Set initial occupancy dropdown value and fare
const currentBus = allBuses.find(bus => bus.id === id);
if (currentBus) {
  document.getElementById("occupancyLevel").value = currentBus.occupancy || "Low";
  document.getElementById("routeFare").value = currentBus.fare || "";
}
}
function forgotPassword(){
const id=prompt("Enter your Driver ID to reset password:");
if(!id)return;
const driver=registeredDrivers.find(d=>d.id===id);
if(!driver){alert("Driver ID not found!"); return;}
const newPass=prompt("Enter new password:");if(!newPass)return;
driver.password=newPass;saveData();alert("Password updated! Login again.");
}

// New: Admin Login (Conceptual)
function showAdminLogin() {
  document.getElementById("homePage").classList.add("hidden");
  document.getElementById("adminLoginPage").classList.remove("hidden");
}

function adminLogin() {
  const adminId = document.getElementById("adminId").value.trim();
  const adminPassword = document.getElementById("adminPassword").value.trim();
  // In a real application, this would involve server-side authentication
  if (adminId === "admin" && adminPassword === "admin123") {
    alert("Admin login successful! (Conceptual: Redirect to admin dashboard)");
    // Here you would redirect to a separate admin dashboard page
    // For this demo, we'll just go back to home
    backToHome();
  } else {
    alert("Invalid Admin ID or Password.");
  }
}


// Driver GPS
function initDriverMap(){if(driverMap){driverMap.remove();}driverMap=L.map("driverMap").setView([22.5726,88.3639],14);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(driverMap);}
function startLocationSharing(){
if(!navigator.geolocation){alert("Geolocation not supported"); return;}
if(isSharing) return;isSharing=true;document.getElementById("locationStatus").textContent="Sharing location...";
driverInterval=navigator.geolocation.watchPosition(
(pos)=>{
const lat=pos.coords.latitude,lng=pos.coords.longitude,timestamp=new Date(pos.timestamp).toLocaleTimeString();
document.getElementById("currentLocation").textContent=`Position: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
document.getElementById("locationTimestamp").textContent=`Last Update: ${timestamp}`;
// New: Use bus icon for driver marker
const busIcon = L.divIcon({
  html: '<i class="fas fa-bus text-blue-600 text-3xl"></i>',
  className: 'custom-div-icon',
  iconSize: [30, 30],
  iconAnchor: [15, 30]
});
if(!driverMarker){driverMarker=L.marker([lat,lng], {icon: busIcon}).addTo(driverMap).bindPopup("Your Bus Location").openPopup();}else{driverMarker.setLatLng([lat,lng]);}
driverMap.setView([lat,lng]);
const driverId=document.getElementById("driverId").value.trim();
const busIndex=allBuses.findIndex(bus=>bus.id===driverId);
if(busIndex!==-1){
  allBuses[busIndex].lat=lat;
  allBuses[busIndex].lng=lng;
  // New: Replace random ETA with conceptual calculation
  allBuses[busIndex].eta=calculateETA(lat, lng, allBuses[busIndex].stops);
  saveData();
}
},
(err)=>{document.getElementById("locationStatus").textContent=`Error: ${err.message}`;alert(`Geolocation Error: ${err.message}`);},
{enableHighAccuracy:true,timeout:5000,maximumAge:0});
}
function stopLocationSharing(){if(driverInterval){navigator.geolocation.clearWatch(driverInterval);driverInterval=null;isSharing=false;document.getElementById("locationStatus").textContent="Location sharing stopped.";if(driverMarker){driverMap.removeLayer(driverMarker);driverMarker=null;}}}

// New: Update Occupancy Level
function updateOccupancy() {
  const driverId = document.getElementById("driverId").value.trim();
  const occupancy = document.getElementById("occupancyLevel").value;
  const busIndex = allBuses.findIndex(bus => bus.id === driverId);
  if (busIndex !== -1) {
    allBuses[busIndex].occupancy = occupancy;
    saveData();
    alert(`Occupancy updated to ${occupancy} for your bus.`);
  } else {
    alert("Could not find your bus to update occupancy.");
  }
}

// New: Update Route Fare
function updateRouteFare() {
  const driverId = document.getElementById("driverId").value.trim();
  const fare = document.getElementById("routeFare").value.trim();
  const busIndex = allBuses.findIndex(bus => bus.id === driverId);
  if (busIndex !== -1) {
    allBuses[busIndex].fare = fare;
    saveData();
    alert(`Fare updated to ${fare} for your bus.`);
  } else {
    alert("Could not find your bus to update fare.");
  }
}

// New: Show Booked Seats Modal
function showBookedSeats() {
  const driverId = document.getElementById("driverId").value.trim();
  const currentBus = allBuses.find(bus => bus.id === driverId);
  if (!currentBus) {
    alert("Bus not found.");
    return;
  }
  const bookedSeatsList = document.getElementById("bookedSeatsList");
  bookedSeatsList.innerHTML = "";
  const bookedSeats = currentBus.seats.filter(seat => seat.status === "occupied");
  document.getElementById("modalBusInfo").textContent = `Route: ${currentBus.route} (${currentBus.name})`;
  if (bookedSeats.length === 0) {
    bookedSeatsList.innerHTML = "<p class='text-gray-500'>No seats are currently booked.</p>";
  } else {
    bookedSeats.forEach(seat => {
      const seatItem = document.createElement("div");
      seatItem.className = "p-3 bg-gray-100 rounded-lg shadow-sm flex justify-between items-center";
      seatItem.innerHTML = `
        <span class="font-bold text-lg">Seat ${seat.id}</span>
        <span class="text-sm text-gray-700">Booked by: ${seat.bookedBy || "N/A"}</span>
      `;
      bookedSeatsList.appendChild(seatItem);
    });
  }
  document.getElementById("bookedSeatsModal").style.display = "flex";
}

// New: Conceptual ETA Calculation (simplified for client-side demo)
function calculateETA(currentLat, currentLng, stops) {
  if (!stops || stops.length === 0) return "N/A";

  const currentPoint = L.latLng(currentLat, currentLng);
  let nextStop = null;
  let minDistanceToNextStop = Infinity;

  // Find the next upcoming stop based on current location
  for (let i = 0; i < stops.length; i++) {
    const stopPoint = L.latLng(stops[i].lat, stops[i].lng);
    const distance = currentPoint.distanceTo(stopPoint);
    // Simple logic: assume the closest stop ahead is the next one.
    // In a real app, you'd check if the bus has passed previous stops.
    if (distance < minDistanceToNextStop) {
      minDistanceToNextStop = distance;
      nextStop = stops[i];
    }
  }

  if (!nextStop) return "N/A";

  // Estimate time based on distance (e.g., 1 minute per 500 meters at ~30km/h)
  const estimatedTimeMinutes = Math.ceil(minDistanceToNextStop / 500);
  return `${estimatedTimeMinutes} min to ${nextStop.name}`;
}

// New: Get Multi-Stop ETAs & Schedule (for user display)
function getMultiStopETAsAndSchedule(bus, userStartStopName, userEndStopName) {
  if (!bus.stops || bus.stops.length === 0 || !bus.lat || !bus.lng) return [];

  const currentPoint = L.latLng(bus.lat, bus.lng);
  const etasAndSchedule = [];

  let startIndex = -1;
  let endIndex = -1;

  // Find user's start and end stop indices
  if (userStartStopName) {
    startIndex = bus.stops.findIndex(s => s.name.toLowerCase() === userStartStopName.toLowerCase());
  }
  if (userEndStopName) {
    endIndex = bus.stops.findIndex(s => s.name.toLowerCase() === userEndStopName.toLowerCase());
  }

  // Determine the range of stops to display
  let displayStartIndex = 0; // Default to start of route
  if (startIndex !== -1) {
    displayStartIndex = startIndex;
  }

  let displayEndIndex = bus.stops.length - 1; // Default to end of route
  if (endIndex !== -1 && endIndex >= displayStartIndex) {
    displayEndIndex = endIndex;
  }

  for (let i = displayStartIndex; i <= displayEndIndex; i++) {
    const stop = bus.stops[i];
    const stopPoint = L.latLng(stop.lat, stop.lng);
    const distance = currentPoint.distanceTo(stopPoint);
    const estimatedTimeMinutes = Math.ceil(distance / 500); // Rough estimate
    
    let deviation = "N/A";
    // Conceptual deviation calculation:
    // This is a simple logic. A real app would use machine learning models or historical data.
    const now = new Date();
    const [scheduledHours, scheduledMinutes] = stop.scheduledTime.split(':').map(Number);
    const scheduledTimeToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), scheduledHours, scheduledMinutes, 0);
    const actualArrivalGuess = new Date(now.getTime() + estimatedTimeMinutes * 60000);
    const timeDifference = (actualArrivalGuess.getTime() - scheduledTimeToday.getTime()) / 60000;
    
    if (Math.abs(timeDifference) > 5) { // If deviation is more than 5 minutes
      deviation = timeDifference > 0 ? `${Math.round(timeDifference)} min late` : `${Math.round(Math.abs(timeDifference))} min early`;
    } else {
      deviation = "On Time";
    }

    etasAndSchedule.push({
      stopName: stop.name,
      eta: estimatedTimeMinutes > 0 ? `${estimatedTimeMinutes} min` : "Arrived",
      scheduledTime: stop.scheduledTime,
      deviation: deviation
    });
  }
  return etasAndSchedule;
}

// User side functionality
let userLocationWatchId = null; // To store the watchId for user's location
function initUserMap() {
  if(userMap){userMap.remove();}
  userMap=L.map("userMap").setView([22.5726,88.3639],14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(userMap);
  updateBusMarkers();
}

function startUserLocationTracking() {
  if (!navigator.geolocation) return;
  if (userLocationWatchId) navigator.geolocation.clearWatch(userLocationWatchId);
  userLocationWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const userIcon = L.divIcon({
        html: '<i class="fas fa-street-view text-red-600 text-3xl"></i>',
        className: 'custom-div-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 30]
      });
      if (!userLocationMarker) {
        userLocationMarker = L.marker([lat, lng], {icon: userIcon}).addTo(userMap).bindPopup("You are here").openPopup();
      } else {
        userLocationMarker.setLatLng([lat, lng]);
      }
      userMap.setView([lat, lng]);
    },
    (err) => console.error("User location error:", err.message),
    {enableHighAccuracy: true, timeout: 5000, maximumAge: 0}
  );
}

// New: Nearest Places Suggestions (Conceptual)
function getNearestPlaces(query) {
  // In a real application, this would be an API call to a geocoding service like Google Maps, OpenCage, etc.
  // For this demo, we'll return a simple, static list of places.
  const places = [
    "Dalhousie Square",
    "Howrah Station",
    "Esplanade",
    "Park Street",
    "Sealdah Station",
    "Salt Lake Sector V",
    "Airport (CCU)",
    "Kolkata Maidan",
    "Gariahat Market",
    "New Town Bus Stand",
    "Jadavpur University"
  ];
  return places.filter(place => place.toLowerCase().includes(query.toLowerCase()));
}

// New: Show Suggestions
function showSuggestions(inputId, listId) {
  const query = document.getElementById(inputId).value;
  const list = document.getElementById(listId);
  list.innerHTML = "";
  if (query.length < 2) {
    list.classList.add('hidden');
    return;
  }
  const suggestions = getNearestPlaces(query);
  suggestions.forEach(place => {
    const li = document.createElement("li");
    li.className = "p-2 hover:bg-gray-100 cursor-pointer";
    li.textContent = place;
    li.onclick = () => {
      document.getElementById(inputId).value = place;
      list.classList.add('hidden');
    };
    list.appendChild(li);
  });
  list.classList.remove('hidden');
}

// New: Helper function to find closest stop
function findClosestStop(inputName) {
  if (!inputName) return null;
  const inputLower = inputName.toLowerCase();
  let closestStop = null;
  let minDistance = Infinity;
  const conceptualInput = getConceptualCoordinates(inputName);

  allBuses.forEach(bus => {
    bus.stops.forEach(stop => {
      const conceptualStop = { lat: stop.lat, lng: stop.lng };
      const distance = getConceptualDistance(conceptualInput, conceptualStop);
      // Fuzziness threshold, adjust as needed
      const FUZZY_THRESHOLD = 0.05; 
      if (distance < minDistance && distance < FUZZY_THRESHOLD) {
        minDistance = distance;
        closestStop = stop.name;
      }
    });
  });
  return closestStop;
}

// New: Conceptual Coordinate Generator (for fuzzy search)
function getConceptualCoordinates(name) {
    // Simple, non-geographical hash-based coordinate
    let lat = 0;
    let lng = 0;
    for (let i = 0; i < name.length; i++) {
        lat += name.charCodeAt(i) * 0.001;
        lng += name.charCodeAt(name.length - 1 - i) * 0.001;
    }
    return { lat: 22.5726 + (lat % 0.1), lng: 88.3639 + (lng % 0.1) };
}

// New: Conceptual Distance Calculator
function getConceptualDistance(coord1, coord2) {
    const dx = coord1.lat - coord2.lat;
    const dy = coord1.lng - coord2.lng;
    return Math.sqrt(dx * dx + dy * dy);
}

function searchRoutes() {
let start=document.getElementById("startLocation").value.trim();
let end=document.getElementById("endLocation").value.trim();

// Fuzzy matching: Find closest actual stop for user input
const closestStart = findClosestStop(start);
const closestEnd = findClosestStop(end);
if (closestStart) {
  start = closestStart;
  document.getElementById("startLocation").value = closestStart;
}
if (closestEnd) {
  end = closestEnd;
  document.getElementById("endLocation").value = closestEnd;
}

const busItems=document.getElementById("busItems");
busItems.innerHTML="";
const foundBuses=allBuses.filter(bus=>
bus.stops.some(s=>s.name.toLowerCase()===start.toLowerCase())&&
bus.stops.some(s=>s.name.toLowerCase()===end.toLowerCase()));
if(foundBuses.length===0){busItems.innerHTML="<p class='text-gray-500'>No routes found for this journey.</p>";}
else{
foundBuses.forEach(bus=>{
const busDiv=document.createElement("div");
const occupancyColor = bus.occupancy === 'Full' ? 'red' : bus.occupancy === 'Medium' ? 'yellow' : 'green';
busDiv.className="p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-100 flex justify-between items-center transition";
busDiv.onclick=()=>selectBus(bus.id);
busDiv.innerHTML=`
<div>
<h4 class="font-semibold text-lg">${bus.name} (${bus.route})</h4>
<p class="text-sm text-gray-600">ETA: <span class="font-medium text-indigo-600">${bus.eta}</span></p>
<p class="text-sm text-gray-600">Occupancy: <span class="font-medium occupancy-${bus.occupancy.toLowerCase()}">${bus.occupancy}</span></p>
<p class="text-sm text-gray-600">Fare: <span class="font-bold text-green-600">₹${bus.fare || "N/A"}</span></p>
</div>
<i class="fas fa-chevron-right text-gray-400"></i>
`;
busItems.appendChild(busDiv);
});
}
updateBusMarkers();
}

function filterBuses(){
const query=document.getElementById("busSearch").value.trim().toLowerCase();
const busItems=document.getElementById("busItems");
busItems.innerHTML="";
const filteredBuses=allBuses.filter(bus=>bus.name.toLowerCase().includes(query)||bus.route.toLowerCase().includes(query));
filteredBuses.forEach(bus=>{
const busDiv=document.createElement("div");
const occupancyColor=bus.occupancy==='Full'?'red':bus.occupancy==='Medium'?'yellow':'green';
busDiv.className="p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-100 flex justify-between items-center transition";
busDiv.onclick=()=>selectBus(bus.id);
busDiv.innerHTML=`
<div>
<h4 class="font-semibold text-lg">${bus.name} (${bus.route})</h4>
<p class="text-sm text-gray-600">ETA: <span class="font-medium text-indigo-600">${bus.eta}</span></p>
<p class="text-sm text-gray-600">Occupancy: <span class="font-medium occupancy-${bus.occupancy.toLowerCase()}">${bus.occupancy}</span></p>
<p class="text-sm text-gray-600">Fare: <span class="font-bold text-green-600">₹${bus.fare || "N/A"}</span></p>
</div>
<i class="fas fa-chevron-right text-gray-400"></i>
`;
busItems.appendChild(busDiv);
});
updateBusMarkers();
}

function updateBusMarkers() {
  Object.values(busMarkers).forEach(marker => userMap.removeLayer(marker));
  busMarkers = {};
  allBuses.forEach(bus => {
    const busIcon = L.divIcon({
      html: `<i class="fas fa-bus text-3xl" style="color:${bus.occupancy==='Full'?'#ef4444':bus.occupancy==='Medium'?'#eab308':'#22c55e'};"></i>`,
      className: 'custom-div-icon',
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });
    const marker = L.marker([bus.lat, bus.lng], { icon: busIcon }).addTo(userMap);
    const popupContent = `
      <div class="font-sans">
        <h4 class="font-bold text-lg mb-1">${bus.name} (${bus.route})</h4>
        <p class="text-sm"><strong>ETA:</strong> <span class="text-indigo-600">${bus.eta}</span></p>
        <p class="text-sm"><strong>Occupancy:</strong> <span class="occupancy-${bus.occupancy.toLowerCase()}">${bus.occupancy}</span></p>
        <p class="text-sm"><strong>Fare:</strong> <span class="font-bold text-green-600">₹${bus.fare || "N/A"}</span></p>
        <button onclick="selectBus('${bus.id}')" class="mt-2 w-full btn-primary text-white text-xs px-2 py-1 rounded-md">View Details</button>
      </div>
    `;
    marker.bindPopup(popupContent);
    busMarkers[bus.id] = marker;
  });
}

function selectBus(busId){
  const bus=allBuses.find(b=>b.id===busId);
  if(!bus){alert("Bus not found!"); return;}
  selectedBusForBooking = bus;
  document.getElementById("selectedBusName").textContent=bus.name;
  document.getElementById("routeFareDisplay").textContent = `(Fare: ₹${bus.fare || "N/A"})`; // Display fare
  document.getElementById("seatBookingSection").classList.remove("hidden");
  renderSeatMatrix(bus);
  // Optional: Center map on the selected bus
  if(bus.lat&&bus.lng){userMap.setView([bus.lat, bus.lng],16);}
}

function renderSeatMatrix(bus) {
  const seatMatrix = document.getElementById("seatMatrix");
  seatMatrix.innerHTML = "";
  bus.seats.forEach(seat => {
    const seatDiv = document.createElement("div");
    seatDiv.className = `seat ${seat.status} rounded-lg shadow-sm cursor-pointer`;
    seatDiv.id = `seat-${seat.id}`;
    seatDiv.innerHTML = `
      <i class="fas fa-chair text-2xl mb-1"></i>
      <span class="seat-id">${seat.id}</span>
      <span class="seat-type">${seat.type}</span>
    `;
    if (seat.status === "occupied") {
      seatDiv.classList.remove('cursor-pointer');
      seatDiv.innerHTML += `<span class="seat-booked-by">Booked</span>`;
    }
    if (seat.status === "vacant") {
      seatDiv.onclick = () => selectSeat(seat.id);
    }
    seatMatrix.appendChild(seatDiv);
  });
}

function selectSeat(seatId) {
  const allSeats = document.querySelectorAll('.seat');
  allSeats.forEach(seat => seat.classList.remove('selected'));
  const selectedSeatDiv = document.getElementById(`seat-${seatId}`);
  if (selectedSeatDiv.classList.contains('occupied')) return;
  selectedSeatDiv.classList.add('selected');
  selectedSeat = seatId;
  document.getElementById("selectedSeatNumber").textContent = seatId;
  document.getElementById("bookingForm").classList.remove("hidden");
}

function confirmBooking() {
  const bookingName = document.getElementById("bookingName").value.trim();
  const bookingAadhar = document.getElementById("bookingAadhar").value.trim();
  if (!bookingName || !bookingAadhar) {
    alert("Please enter your Name and Aadhar Number.");
    return;
  }
  if (!selectedBusForBooking || !selectedSeat) {
    alert("Please select a bus and a seat first.");
    return;
  }
  const busIndex = allBuses.findIndex(bus => bus.id === selectedBusForBooking.id);
  const seatIndex = allBuses[busIndex].seats.findIndex(seat => seat.id === selectedSeat);
  if (busIndex !== -1 && seatIndex !== -1) {
    allBuses[busIndex].seats[seatIndex].status = "occupied";
    allBuses[busIndex].seats[seatIndex].bookedBy = bookingName;
    allBuses[busIndex].seats[seatIndex].aadhar = bookingAadhar;
    saveData();
    alert(`Booking successful for seat ${selectedSeat}! Your seat is now reserved.`);
    renderSeatMatrix(allBuses[busIndex]); // Re-render to show updated status
    document.getElementById("bookingForm").classList.add("hidden");
    selectedSeat = null;
  }
}

function openTicketing() {
  alert("Digital ticketing functionality is conceptual. In a real app, this would open a payment gateway or QR code scanner.");
}

function submitFeedback() {
  const feedback = document.getElementById("feedbackText").value.trim();
  if (feedback.length > 0) {
    alert("Thank you for your feedback! Your report has been submitted.");
    document.getElementById("feedbackText").value = "";
  } else {
    alert("Please write your feedback before submitting.");
  }
}

function setBusAlert() {
  const bus = document.getElementById("alertBus").value.trim();
  const stop = document.getElementById("alertStop").value.trim();
  const minutes = document.getElementById("alertMinutes").value.trim();
  if (bus && stop && minutes) {
    alert(`Alert set for bus '${bus}' at stop '${stop}' when it is ${minutes} minutes away.`);
  } else {
    alert("Please fill in all alert details.");
  }
}

function triggerEmergency(mode) {
  alert(`Emergency alert sent from ${mode} mode. Authorities have been notified.`);
  // In a real application, this would send an alert to a central server with the user's/driver's location.
}

// Language and Theme Toggle
function changeLanguage(lang) {
  alert(`Language changed to ${lang}. (Conceptual: requires translations)`);
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const icon = document.getElementById('themeToggle').querySelector('i');
  if (document.body.classList.contains('dark-mode')) {
    icon.classList.remove('fa-moon');
    icon.classList.add('fa-sun');
  } else {
    icon.classList.remove('fa-sun');
    icon.classList.add('fa-moon');
  }
  // Optional: Update map tile layer for better visibility in dark mode
  if (userMap) {
    // You'd need a separate dark mode tile layer URL for a real app
    // e.g., L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', ...);
  }
}

// Modal closing function
function closeModal(modalId) {
  document.getElementById(modalId).style.display = "none";
}
</script>

</div>
</body>
</html>